#!/bin/bash
# $KILLSWITCH Pre-commit Hook
# Prevents accidental commits of secrets

echo "Running secret scan..."

# Patterns to check for
PATTERNS=(
    "STRIPE_SECRET_KEY"
    "STRIPE_WEBHOOK_SECRET"
    "PRIVATE_KEY"
    "DATABASE_URL"
    "PASSWORD"
    "API_KEY"
    "JWT_SECRET"
    "TWILIO_TOKEN"
    "TWILIO_SID"
    "sk_live_"
    "sk_test_"
    "ghp_"
    "github_pat_"
    "-----BEGIN RSA PRIVATE KEY-----"
    "-----BEGIN PRIVATE KEY-----"
    "-----BEGIN EC PRIVATE KEY-----"
)

# Get staged files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)

if [ -z "$STAGED_FILES" ]; then
    exit 0
fi

FOUND_SECRETS=0

for PATTERN in "${PATTERNS[@]}"; do
    MATCHES=$(echo "$STAGED_FILES" | xargs grep -l "$PATTERN" 2>/dev/null)
    if [ -n "$MATCHES" ]; then
        echo "ERROR: Found potential secret '$PATTERN' in:"
        echo "$MATCHES"
        FOUND_SECRETS=1
    fi
done

# Check for .env files
ENV_FILES=$(echo "$STAGED_FILES" | grep -E "\.env|\.env\.")
if [ -n "$ENV_FILES" ]; then
    echo "ERROR: Attempting to commit environment files:"
    echo "$ENV_FILES"
    FOUND_SECRETS=1
fi

# Check for key files
KEY_FILES=$(echo "$STAGED_FILES" | grep -E "\.(pem|key|p12|pfx)$")
if [ -n "$KEY_FILES" ]; then
    echo "ERROR: Attempting to commit key files:"
    echo "$KEY_FILES"
    FOUND_SECRETS=1
fi

if [ $FOUND_SECRETS -eq 1 ]; then
    echo ""
    echo "Commit blocked. Remove secrets before committing."
    echo "If this is a false positive, use: git commit --no-verify"
    exit 1
fi

echo "No secrets detected. Proceeding with commit."
exit 0
